name: Sync Notion Results

on:
  workflow_dispatch:
  schedule:
    - cron: "*/30 * * * *"

permissions:
  contents: write

concurrency:
  group: notion-sync
  cancel-in-progress: true

jobs:
  sync:
    runs-on: ubuntu-latest
    env:
      TZ: Europe/Moscow

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Fetch from Notion (database query)
        env:
          NOTION_TOKEN: ${{ secrets.NOTION_TOKEN }}
          NOTION_DB_ID: ${{ secrets.NOTION_DB_ID }}
        run: |
          set -e
          curl -sS -X POST "https://api.notion.com/v1/databases/${NOTION_DB_ID}/query" \
            -H "Authorization: Bearer ${NOTION_TOKEN}" \
            -H "Notion-Version: 2022-06-28" \
            -H "Content-Type: application/json" \
            --data '{"page_size": 100}' \
            > notion_raw.json

      - name: Convert to data.json + summary.json (auto-detect props)
        run: |
          node <<'EOF'
          const fs = require("fs");

          const raw = JSON.parse(fs.readFileSync("notion_raw.json","utf8"));
          if (raw && raw.object === "error") {
            console.error("Notion API error:", raw);
            process.exit(1);
          }

          const results = Array.isArray(raw.results) ? raw.results : [];
          console.log("Rows fetched:", results.length);

          const norm = (s) => (s || "").toString().trim().toLowerCase();

          // --- Auto-detect property keys by type (title/number/date/created_time)
          function detectKeys(page) {
            const props = page.properties || {};
            const entries = Object.entries(props);

            const titleKey = entries.find(([,p]) => p?.type === "title")?.[0] || null;
            const numberKey = entries.find(([,p]) => p?.type === "number")?.[0] || null;

            // Prefer property named "Date" if it exists; otherwise first date/created_time
            let dateKey = ("Date" in props) ? "Date" : null;
            if (dateKey && !["date","created_time"].includes(props[dateKey]?.type)) dateKey = null;

            if (!dateKey) {
              dateKey = entries.find(([,p]) => p?.type === "date")?.[0]
                     || entries.find(([,p]) => p?.type === "created_time")?.[0]
                     || null;
            }

            return { titleKey, numberKey, dateKey };
          }

          const samplePage = results[0];
          if (!samplePage) {
            fs.writeFileSync("data.json", "[]");
            fs.writeFileSync("summary.json", JSON.stringify({
              generated_at: new Date().toISOString(),
              timezone: process.env.TZ || "system",
              today: null,
              daily_today: 0,
              cards_30d: 0,
              qs_30d: 0,
              note: "No rows returned from Notion."
            }, null, 2));
            console.log("No rows. Wrote empty outputs.");
            process.exit(0);
          }

          const keys = detectKeys(samplePage);
          console.log("Detected keys:", keys);

          function titleText(p) {
            if (!p) return "";
            if (p.type === "title") return (p.title || []).map(t => t.plain_text).join("").trim();
            if (p.type === "rich_text") return (p.rich_text || []).map(t => t.plain_text).join("").trim();
            return "";
          }

          function pickDate(page, dateKey) {
            const props = page.properties || {};
            const d = dateKey ? props[dateKey] : null;

            if (d?.type === "date") return d.date?.start ?? null;
            if (d?.type === "created_time") return d.created_time ?? null;

            // fallback: у страницы есть created_time всегда
            return page.created_time ?? null;
          }

          function dayKey(date){
            const y = date.getFullYear();
            const m = String(date.getMonth()+1).padStart(2,"0");
            const d = String(date.getDate()).padStart(2,"0");
            return `${y}-${m}-${d}`;
          }

          function parseISO(s){
            if (!s) return null;
            const d = new Date(s);
            return Number.isFinite(d.getTime()) ? d : null;
          }

          // Rolling 30 days: today-29..today (локально по TZ за счёт env TZ)
          const now = new Date();
          const todayKey = dayKey(now);

          const start = new Date(now);
          start.setHours(0,0,0,0);
          start.setDate(start.getDate() - 29);

          // Build data.json
          const data = results.map(page => {
            const props = page.properties || {};

            const name = keys.titleKey ? titleText(props[keys.titleKey]) : "";
            const value = keys.numberKey ? (props[keys.numberKey]?.number ?? 0) : 0;
            const dateStr = pickDate(page, keys.dateKey);

            return { name, value, date: dateStr };
          });

          fs.writeFileSync("data.json", JSON.stringify(data, null, 2));

          // Compute summary.json
          let daily_today = 0;
          let cards_30d = 0;
          let qs_30d = 0;

          for (const row of data) {
            const type = norm(row.name);  // ожидаем "daily" и "today"
            const d = parseISO(row.date);
            if (!d) continue;

            if (d < start || d > now) continue;

            const k = dayKey(d);
            const v = Number(row.value) || 0;

            if (type === "daily") {
              cards_30d += v;
              if (k === todayKey) daily_today += v;
            } else if (type === "today") {
              qs_30d += v;
            }
          }

          const summary = {
            generated_at: now.toISOString(),
            timezone: process.env.TZ || "system",
            detected: keys,            // чтобы ты видел, что он выбрал
            today: todayKey,
            daily_today,
            cards_30d,
            qs_30d
          };

          fs.writeFileSync("summary.json", JSON.stringify(summary, null, 2));
          console.log("summary:", summary);
          EOF

      - name: Commit data.json + summary.json
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add data.json summary.json
          git diff --cached --quiet && echo "No changes to commit" && exit 0
          git commit -m "Update data.json + summary.json"
          git push
